Controller node

1.  Update the system
sudo su -
apt-get update
apt-get install vim
apt-get dist-upgrade -y
reboot

2. Install OpenStack "base" dependecies

apt-get install mysql-server python-mysqldb ntp curl openssl rabbitmq-server python-keyring

Edit my.cnf...
vi /etc/mysql/my.cnf

bind-address		= 10.10.1.2
collation-server = utf8_general_ci
init-connect='SET NAMES utf8'
character-set-server = utf8


Creating the required databases:

service mysql restart
mysql -u root -p

Once within MySQL prompt, create the databases:

CREATE DATABASE keystone;
GRANT ALL ON keystone.* TO 'keystoneUser'@'%' IDENTIFIED BY 'keystonePass';
CREATE DATABASE glance;
GRANT ALL ON glance.* TO 'glanceUser'@'%' IDENTIFIED BY 'glancePass';
CREATE DATABASE nova;
GRANT ALL ON nova.* TO 'novaUser'@'%' IDENTIFIED BY 'novaPass';
CREATE DATABASE cinder;
GRANT ALL ON cinder.* TO 'cinderUser'@'%' IDENTIFIED BY 'cinderPass';
CREATE DATABASE neutron;
GRANT ALL ON neutron.* TO 'neutronUser'@'%' IDENTIFIED BY 'neutronPass';
CREATE DATABASE heat;
GRANT ALL ON heat.* TO 'heatUser'@'%' IDENTIFIED BY 'heatPass';
quit;

2.1 Install keystone

apt-get install keystone
Edit the keystone.conf and and change it for this:

vi /etc/keystone/keystone.conf
File contents:

[DEFAULT]
admin_token = ADMIN

connection = mysql://keystoneUser:keystonePass@10.10.1.2/keystone

Then run:

keystone-manage db_sync

service keystone restart

wget https://raw.githubusercontent.com/enelen/geexcloud-vagrant/icehouse/keystone_basic.sh
wget https://raw.githubusercontent.com/enelen/geexcloud-vagrant/icehouse/keystone_endpoints_basic.sh
Then run:
chmod +x keystone_basic.sh
chmod +x keystone_endpoints_basic.sh

./keystone_basic.sh
./keystone_endpoints_basic.sh

# Preliminary Keystone test
curl http://10.10.1.2:35357/v2.0/endpoints -H 'x-auth-token: ADMIN' | python -m json.tool

vim openrc 


export OS_TENANT_NAME=admin
export OS_USERNAME=admin
export OS_PASSWORD=admin_pass
export OS_AUTH_URL="http://10.10.1.2:5000/v2.0/"


. openrc


Install Glance

apt-get install glance python-mysqldb

3.1. Configure Glance API

Edit glance-api.conf...

vi /etc/glance/glance-api.conf
[DEFAULT]
bind_host = 0.0.0.0

sql_connection = mysql://glanceUser:glancePass@10.10.1.2/glance
registry_host = 10.10.1.2

[keystone_authtoken]
auth_host = 10.10.1.2
auth_port = 35357
auth_protocol = http
admin_tenant_name = service
admin_user = glance
admin_password = service_pass

[paste_deploy]
flavor = keystone

3.2. Configure Glance Registry

Edit glance-registry.conf...

vi /etc/glance/glance-registry.conf
With:

[DEFAULT]
bind_host = 0.0.0.0

sql_connection = mysql://glanceUser:glancePass@10.10.1.2/glance

[keystone_authtoken]
auth_host = 10.10.1.2
auth_port = 35357
auth_protocol = http
admin_tenant_name = service
admin_user = glance
admin_password = service_pass

[paste_deploy]
flavor = keystone

Then run:

glance-manage db_sync
chown glance.glance /var/lib/glance/images

service glance-api restart; service glance-registry restart

3.3. Download some O.S. Images ready for the Cloud environment
glance image-create --location http://download.cirros-cloud.net/0.3.1/cirros-0.3.1-x86_64-disk.img --name "CirrOS Minimalist - 64-bit - Cloud Based Image" --is-public true --container-format bare --disk-format qcow2

4. Install Nova
apt-get install nova-api nova-cert nova-consoleauth nova-scheduler nova-conductor nova-novncproxy novnc

4.1 Configure Nova
cd /etc/nova
Edit apt-paste.ini...
cp api-paste.ini api-paste.ini.orig
vi api-paste.ini
With:

[filter:authtoken]
paste.filter_factory = keystoneclient.middleware.auth_token:filter_factory
auth_host = controller.yourdomain.com
auth_port = 35357
auth_protocol = http
admin_tenant_name = service
admin_user = nova
admin_password = service_pass
# signing_dir is configurable, but the default behavior of the authtoken
# middleware should be sufficient.  It will create a temporary directory
# in the home directory for the user the nova process is running as.
#signing_dir = /var/lib/nova/keystone-signing
# Workaround for https://bugs.launchpad.net/nova/+bug/1154809
auth_version = v2.0

Then run:
mv /etc/nova/nova.conf /etc/nova/nova.conf.orig
wget https://raw.githubusercontent.com/enelen/geexcloud-vagrant/icehouse/nova.conf
chown nova: /etc/nova/nova.conf

chmod 640 /etc/nova/nova.conf
nova-manage db sync

cd /etc/init/; for i in $(ls nova-* |cut -d "." -f1); do sudo service $i restart; done



Neutron-server on controller node
Run:
apt-get install neutron-server neutron-plugin-openvswitch-agent neutron
5.1. Configure Neutron

cd /etc/neutron/

First, take a note of the "Service Tenant ID" with:

keystone tenant-get service
Edit neutron.conf...
cp neutron.conf neutron.conf.orig
vi /etc/neutron/neutron.conf
With:

[DEFAULT]
state_path = /var/lib/neutron
lock_path = $state_path/lock
bind_host = 0.0.0.0
core_plugin = neutron.plugins.ml2.plugin.Ml2Plugin
auth_strategy = keystone
allow_overlapping_ips = True
rabbit_host = 10.10.1.2
notification_driver = neutron.openstack.common.notifier.rpc_notifier
nova_url = http://10.10.1.2:8774
nova_region_name = RegionOne
nova_admin_username = nova
nova_admin_tenant_id = d4966c58d63e4290adaaba76746b2153 
nova_admin_password = service_pass
nova_admin_auth_url = http://10.10.1.2:35357/v2.0
[quotas]
[agent]
root_helper = sudo /usr/bin/neutron-rootwrap /etc/neutron/rootwrap.conf
[keystone_authtoken]
auth_host = 10.10.1.2
auth_port = 35357
auth_protocol = http
admin_tenant_name = service 
admin_user = neutron
admin_password = service_pass
signing_dir = $state_path/keystone-signing
[database]
connection = mysql://neutronUser:neutronPass@10.10.1.2/neutron 
[service_providers]
service_provider=LOADBALANCER:Haproxy:neutron.services.loadbalancer.drivers.haproxy.plugin_driver.HaproxyOnHostPluginDriver:default
service_provider=VPN:openswan:neutron.services.vpn.service_drivers.ipsec.IPsecVPNDriver:default


cd plugins/ml2
cp ml2_conf.ini ml2_conf.ini.orig
Edit ml2_conf.ini...

vi /etc/neutron/plugins/ml2/ml2_conf.ini
[ml2]
type_drivers = gre
tenant_network_types = gre
mechanism_drivers = openvswitch
[ml2_type_flat]
[ml2_type_vlan]
[ml2_type_gre]
tunnel_id_ranges = 1:1000
[ml2_type_vxlan]
[securitygroup]
firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver
enable_security_group = True




Neutron Node

sudo su -
apt-get update
apt-get dist-upgrade -y
apt-get install vim
reboot


Edit /etc/sysctl.conf to contain the following:

net.ipv4.ip_forward=1
net.ipv4.conf.all.rp_filter=0
net.ipv4.conf.default.rp_filter=0

sysctl -p

To install the Networking components

apt-get install neutron-plugin-ml2 neutron-plugin-openvswitch-agent  neutron-l3-agent neutron-dhcp-agent bridge-utils


cd /etc/neutron
cp neutron.conf neutron.conf.orig
cd plugins/ml2
cp ml2_conf.ini ml2_conf.ini.orig
cd /etc/neutron

copy neutron.conf and ml2_conf.ini from control node

To configure the Layer-3 (L3) agent

cp l3_agent.ini l3_agent.ini.orig
edit l3_agent.ini
[DEFAULT]
interface_driver = neutron.agent.linux.interface.OVSInterfaceDriver
use_namespaces = True
external_network_bridge = br-ex

cp dhcp_agent.ini  dhcp_agent.ini.orig
edit dhcp_agent.ini


[DEFAULT]
interface_driver = neutron.agent.linux.interface.OVSInterfaceDriver
dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq


 cp metadata_agent.ini metadata_agent.ini.orig
 edit metadata_agent.ini

 [DEFAULT]
auth_url = http://10.10.1.2:5000/v2.0
auth_region = RegionOne
admin_tenant_name = service
admin_user = neutron
admin_password = service_pass
nova_metadata_ip = 10.10.1.2
nova_metadata_port = 8775
metadata_proxy_shared_secret = metasecret13




Restart the OVS service:

# service openvswitch-switch restart
Add the integration bridge:

# ovs-vsctl add-br br-int
Add the external bridge:

# ovs-vsctl add-br br-ex
Add a port to the external bridge that connects to the physical external network interface (eth2):

# ovs-vsctl add-port br-ex eth3
cd /etc/init/; for i in $(ls -1 neutron-* | cut -d \. -f 1); do sudo service $i restart; done


cd /etc/init/; for i in $(ls -1 neutron-* | cut -d \. -f 1); do sudo service $i restart; done


Compute


